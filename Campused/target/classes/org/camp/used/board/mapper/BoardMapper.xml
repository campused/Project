<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="org.camp.used.board.mapper.BoardMapper">
 
 	<resultMap type="org.camp.used.board.BoardSearchResDTO" id="searchMap">
 		<id property="bno" column="bno"/>
 		<result property="bstate" column="bstate"/>
 		<result property="bdeleted" column="bdeleted"/>
 		<result property="btitle" column="btitle"/>
 		<result property="bcontent" column="bcontent"/>
 		<result property="bprice" column="bprice"/>
 		<result property="bregdate" column="bregdate"/>
 		<result property="bmoddate" column="bmoddate"/>
 		<result property="member_mno" column="member_mno"/>
 		<collection property="memberList" resultMap="memberMap"/>
 	</resultMap>
 	
 	 <resultMap type="org.camp.member.dto.MemberGetOneDTO" id="memberMap">
 		<result property="memail" column="memail"/>
 		<result property="mnickname" column="mnickname"/>
 		<result property="maddress" column="maddress"/>
 		<result property="mphone" column="mphone"/>
 		<result property="mauthority" column="mauthority"/>
 		<result property="mlikecount" column="mlikecount"/>
 		<result property="mregdate" column="mregdate"/>
 		<result property="mmoddate" column="mmoddate"/>
 	</resultMap>
 
  	<sql id="search">
  		<if test="arr != null">
  			<foreach item="tp" collection="arr" separator="OR" open="(" close=")">
  				<if test="tp == 't'.toString()">
					b.btitle like concat('%', #{keyword},'%') 	  				
  				</if>
  				<if test="tp == 'c'.toString()">
					b.bcontent like concat('%', #{keyword},'%')				
  				</if>
  				<if test="tp == 'w'.toString()">
					m.mnickname like concat('%', #{keyword},'%') 
  				</if>
  			</foreach>
  		</if>
  	</sql>

	<insert id="insert"> 
		insert into tbl_board (bstate, btitle, bcontent, bprice, bdeleted, bregdate, bmoddate, member_mno)
		values (#{bstate}, #{btitle}, #{bcontent}, #{bprice}, #{bdeleted}, now(), now(), #{memberMno})
	</insert>
	
	<delete id="delete">
		update tbl_board set bdeleted = true
		where bno = #{bno}
	</delete>
	
	<select id="getCount" resultType="int">
  		select COUNT(b.bno) from tbl_board b left JOIN tbl_member m ON b.member_mno = m.mno 
  		<include refid="search"></include>
  		and b.bno > 0
  	</select>
  	
  	<select id="getPageList" resultMap="searchMap">

  		SELECT *, COUNT(b.bno) over () AS totalCnt FROM tbl_board b left JOIN tbl_member m ON b.member_mno = m.mno  
  		where <include refid="search"></include> and b.bno > 0 
  		ORDER BY bno DESC LIMIT #{skip}, #{size}
  		
  	</select>
 
 </mapper>